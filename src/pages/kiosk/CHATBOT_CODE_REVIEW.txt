================================================================================
                    ENGEX CHATBOT - CODE REVIEW DOCUMENTATION
================================================================================
                    Faculty of Engineering, University of Peradeniya
                              EngEx 2025 Exhibition
================================================================================

ğŸ“ TABLE OF CONTENTS
================================================================================
1. Overview & Architecture
2. File Structure & Purpose
3. Database Connection (Supabase)
4. Gemini AI Integration
5. API Server Setup
6. Frontend Components
7. Data Flow & How It Works
8. Configuration Files
9. Code Explanation - File by File
10. How to Run & Test


================================================================================
1. OVERVIEW & ARCHITECTURE
================================================================================

The EngEx Chatbot is an AI-powered assistant that helps visitors navigate the
Faculty of Engineering Exhibition. It uses:

â€¢ React + TypeScript for the frontend UI
â€¢ Express.js API server for backend operations
â€¢ Supabase (PostgreSQL) as the cloud database
â€¢ Google Gemini AI (gemini-2.0-flash-exp) for intelligent responses
â€¢ Vite as the development server

ARCHITECTURE DIAGRAM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚â”€â”€â”€â”€â”€â–¶â”‚  ChatBot UI  â”‚â”€â”€â”€â”€â”€â–¶â”‚  Gemini AI  â”‚â”€â”€â”€â”€â”€â–¶â”‚ Response â”‚
â”‚  (User)     â”‚      â”‚(ChatBotPage) â”‚      â”‚  Service    â”‚      â”‚ to User  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                      â”‚
                            â”‚                      â”‚
                            â–¼                      â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ Knowledge    â”‚â”€â”€â”€â”€â”€â–¶â”‚   API       â”‚
                     â”‚ Base Service â”‚      â”‚  Server     â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  (Port 8080)â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”‚
                                                  â–¼
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚  Supabase   â”‚
                                           â”‚  Database   â”‚
                                           â”‚(PostgreSQL) â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
2. FILE STRUCTURE & PURPOSE
================================================================================

ğŸ“‚ src/pages/kiosk/
â”œâ”€â”€ ğŸ“„ ChatBotPage.tsx                 - Main chatbot UI component
â”œâ”€â”€ ğŸ“„ ChatBot.css                     - Chatbot styling
â”‚
â”œâ”€â”€ ğŸ“‚ utils/
â”‚   â”œâ”€â”€ ğŸ“„ geminiService.ts            - Google Gemini AI integration
â”‚   â”œâ”€â”€ ğŸ“„ knowledgeBaseService.ts     - API communication layer
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“‚ chatbot-server/
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ knowledge-base-api.js   - Express.js API server
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ db.js                   - Supabase database connection
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ .env                    - Environment variables
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ package.json            - Server dependencies
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ğŸ“‚ sql/
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ complete-knowledge-base.sql  - Full database schema
â”‚   â”‚       â””â”€â”€ ğŸ“„ add-departments-simple.sql   - Department data

KEY FILES EXPLAINED:

1. ChatBotPage.tsx          â†’ User interface (chat window, messages, input)
2. geminiService.ts         â†’ AI brain (sends prompts to Gemini)
3. knowledgeBaseService.ts  â†’ Fetches data from API
4. knowledge-base-api.js    â†’ Backend server (handles requests)
5. db.js                    â†’ Database connection to Supabase
6. .env                     â†’ API keys and configuration


================================================================================
3. DATABASE CONNECTION (SUPABASE)
================================================================================

ğŸ—„ï¸ DATABASE: Supabase Cloud PostgreSQL Database

FILE: utils/chatbot-server/db.js
--------------------------------------------------------------------------------

CODE:
```javascript
const { createClient } = require('@supabase/supabase-js')
require('dotenv').config()

const supabaseUrl = process.env.SUPABASE_URL
const supabaseKey = process.env.SUPABASE_SERVICE_KEY

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ Missing Supabase credentials!')
  process.exit(1)
}

const supabase = createClient(supabaseUrl, supabaseKey)
```

WHAT THIS DOES:
1. Imports Supabase client library
2. Loads environment variables from .env file
3. Gets Supabase URL and API key from environment
4. Creates a connection to Supabase database
5. Exports the connection for use in other files

ENVIRONMENT VARIABLES (.env file):
```
SUPABASE_URL=https://nzomtfszluifyvfmsoei.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
KB_API_PORT=8080
```

DATABASE TABLE: knowledge_base
Columns:
- id (integer)           â†’ Unique identifier
- category (text)        â†’ Type of information (department, event, facility, etc.)
- title (text)           â†’ Title of the entry
- content (text)         â†’ Detailed information
- tags (text[])          â†’ Search keywords
- metadata (jsonb)       â†’ Additional data (phone, email, location, etc.)
- is_active (boolean)    â†’ Whether entry is visible
- created_at (timestamp) â†’ When created
- updated_at (timestamp) â†’ Last modified

CURRENT DATABASE CONTENT: 43 active entries
- Departments: Civil, Mechanical, Electrical, Computer, etc.
- Events: Exhibition schedule, workshops, demonstrations
- Facilities: Labs, lecture halls, libraries
- Contacts: Dean's office, department heads, administration
- Campus Map: Buildings, zones, navigation


================================================================================
4. GEMINI AI INTEGRATION
================================================================================

ğŸ¤– AI MODEL: Google Gemini 2.0 Flash (gemini-2.0-flash-exp)

FILE: utils/geminiService.ts
--------------------------------------------------------------------------------

CLASS: GeminiService

INITIALIZATION:
```typescript
constructor() {
  const apiKey = import.meta.env.VITE_GOOGLE_GEMINI_API_KEY
  
  if (apiKey && apiKey !== 'your_api_key_here') {
    this.genAI = new GoogleGenerativeAI(apiKey)
    this.model = this.genAI.getGenerativeModel({ 
      model: 'gemini-2.0-flash-exp',
      generationConfig: {
        temperature: 0.1,      // Low = consistent, factual responses
        topK: 1,               // Only top result = maximum consistency
        topP: 0.1,             // Low diversity = deterministic answers
        maxOutputTokens: 4096, // Max length = 4096 tokens (~3000 words)
      }
    })
  }
}
```

WHAT THIS DOES:
1. Gets Gemini API key from environment variable
2. Creates Google Generative AI client
3. Configures the model with specific settings:
   - temperature: 0.1 = very factual, not creative
   - topK: 1 = always pick best answer
   - topP: 0.1 = consistent responses
   - maxOutputTokens: 4096 = detailed, long answers allowed

KEY METHODS:

1. isGreeting(message: string): boolean
   â†’ Detects if user said "hi", "hello", etc.
   â†’ Returns true for greetings, false otherwise

2. getIntroductionResponse(): string
   â†’ Returns welcome message with chatbot capabilities
   â†’ Shows what chatbot can help with
   â†’ Suggests example questions

3. generateResponse(prompt: string): Promise<string>
   â†’ Main method that processes user questions
   â†’ Gets data from knowledge base
   â†’ Sends to Gemini AI with instructions
   â†’ Returns AI response

HOW GEMINI AI WORKS:

STEP 1: User asks a question
        â†“
STEP 2: Check if it's a greeting â†’ Return introduction
        â†“
STEP 3: Fetch relevant data from Supabase database
        â†“
STEP 4: Build enhanced prompt with:
        - AI instructions (how to behave)
        - Knowledge base content (database data)
        - User's question
        â†“
STEP 5: Send to Gemini AI API
        â†“
STEP 6: Gemini reads instructions + data + question
        â†“
STEP 7: Gemini generates detailed answer using ONLY database data
        â†“
STEP 8: Return response to user


AI PROMPT STRUCTURE:
```
You are an AI assistant for Faculty of Engineering...

KNOWLEDGE BASE CONTENT:
[All relevant data from database inserted here]

RULES:
1. Use ONLY knowledge base data
2. Give detailed answers with bullet points
3. Include ALL information from database
4. For off-topic questions, redirect to EngEx topics
...

User Question: [User's question here]
```

EXAMPLE FLOW:
User: "What departments are there?"
  â†“
knowledgeBaseService fetches all department records from Supabase
  â†“
geminiService receives: {Civil Engineering data, Mechanical data, etc.}
  â†“
Sends to Gemini: "Here's knowledge base... User asks: What departments?"
  â†“
Gemini AI responds with formatted list of all 8 departments
  â†“
User sees detailed answer with bullet points


================================================================================
5. API SERVER SETUP
================================================================================

ğŸŒ SERVER: Express.js REST API on Port 8080

FILE: utils/chatbot-server/knowledge-base-api.js
--------------------------------------------------------------------------------

DEPENDENCIES:
```javascript
const express = require('express')
const cors = require('cors')
const { supabase } = require('./db')
```

SERVER CONFIGURATION:
```javascript
const app = express()
const PORT = process.env.KB_API_PORT || 8080

app.use(cors())              // Allow cross-origin requests
app.use(express.json())      // Parse JSON request bodies
app.listen(PORT, '127.0.0.1') // Bind to localhost only
```

WHY 127.0.0.1?
- Avoids permission errors on Windows
- More secure (only accessible from local machine)
- Port 8080 doesn't require admin privileges

API ENDPOINTS:

1. GET /health
   â†’ Check if server is running
   â†’ Returns: { success: true, message: "API is running" }

2. POST /api/knowledge-base/query
   â†’ Search database by keywords
   â†’ Body: { query: "departments" }
   â†’ Returns: Array of matching records

3. GET /api/knowledge-base/search?q=keyword
   â†’ Search using URL parameter
   â†’ Example: /api/knowledge-base/search?q=dean
   â†’ Returns: Filtered results

4. GET /api/knowledge-base/all
   â†’ Get all active records from database
   â†’ No parameters needed
   â†’ Returns: All 43 entries

5. POST /api/conversations/save
   â†’ Save chat conversation history
   â†’ Body: { userId, messages, timestamp }
   â†’ Returns: Saved conversation ID

CODE EXAMPLE - QUERY ENDPOINT:
```javascript
app.post('/api/knowledge-base/query', async (req, res) => {
  const { query } = req.body
  
  // Search in title, content, tags, and category
  const { data, error } = await supabase
    .from('knowledge_base')
    .select('*')
    .or(`title.ilike.%${query}%,content.ilike.%${query}%`)
    .eq('is_active', true)
  
  if (error) {
    return res.status(500).json({ error: error.message })
  }
  
  res.json({ success: true, data })
})
```

WHAT THIS DOES:
1. Receives query from frontend
2. Searches Supabase database (case-insensitive)
3. Filters for active entries only
4. Returns matching records as JSON


================================================================================
6. FRONTEND COMPONENTS
================================================================================

ğŸ“± UI COMPONENT: ChatBotPage.tsx

FILE: src/pages/kiosk/ChatBotPage.tsx
--------------------------------------------------------------------------------

IMPORTS:
```typescript
import React, { useState, useRef, useEffect } from 'react'
import { MessageCircle, Send, X, Loader2 } from 'lucide-react'
import { geminiService } from './utils/geminiService'
import './ChatBot.css'
```

STATE MANAGEMENT:
```typescript
const [isOpen, setIsOpen] = useState(false)           // Chat window open/closed
const [messages, setMessages] = useState<Message[]>([]) // Chat history
const [inputMessage, setInputMessage] = useState('')   // Current user input
const [isLoading, setIsLoading] = useState(false)      // Waiting for response
```

MESSAGE STRUCTURE:
```typescript
interface Message {
  id: string          // Unique ID (timestamp-based)
  text: string        // Message content
  sender: 'user' | 'bot'  // Who sent it
  timestamp: Date     // When sent
}
```

KEY FUNCTIONS:

1. getBotResponse(userMessage: string)
   â†’ Calls geminiService.generateResponse()
   â†’ Returns AI-generated answer
   â†’ Handles errors gracefully

2. handleSendMessage()
   â†’ Triggered when user clicks Send or presses Enter
   â†’ Adds user message to chat
   â†’ Calls getBotResponse()
   â†’ Displays bot response
   â†’ Scrolls to bottom

3. useEffect for auto-scroll
   â†’ Monitors messages array
   â†’ Scrolls chat to bottom when new message arrives

COMPONENT STRUCTURE:
```
<ChatBotPage>
  â”œâ”€â”€ Floating Button (bottom-right corner)
  â”‚   â””â”€â”€ Opens/closes chat window
  â”‚
  â””â”€â”€ Chat Window (slides in when open)
      â”œâ”€â”€ Header
      â”‚   â”œâ”€â”€ Title: "EngEx Assistant"
      â”‚   â”œâ”€â”€ Status: "AI Active" (green dot)
      â”‚   â””â”€â”€ Close button (X)
      â”‚
      â”œâ”€â”€ Messages Container
      â”‚   â”œâ”€â”€ Initial welcome message
      â”‚   â”œâ”€â”€ User messages (right-aligned, blue)
      â”‚   â””â”€â”€ Bot messages (left-aligned, white)
      â”‚
      â””â”€â”€ Input Area
          â”œâ”€â”€ Text input field
          â””â”€â”€ Send button
```

UI FEATURES:
âœ… Smooth slide-in animation
âœ… Auto-scroll to latest message
âœ… Loading indicator while AI responds
âœ… Disabled input while processing
âœ… Enter key to send message
âœ… Responsive design for all screen sizes
âœ… Status indicator (green = AI active)


================================================================================
7. DATA FLOW & HOW IT WORKS
================================================================================

ğŸ”„ COMPLETE USER INTERACTION FLOW:

STEP-BY-STEP PROCESS:

1ï¸âƒ£ USER OPENS CHATBOT
   â”œâ”€â”€ User clicks floating chatbot button
   â”œâ”€â”€ ChatBotPage sets isOpen = true
   â”œâ”€â”€ Chat window slides in from bottom-right
   â””â”€â”€ Shows welcome message

2ï¸âƒ£ USER TYPES QUESTION
   â”œâ”€â”€ User types in input field: "What departments are there?"
   â”œâ”€â”€ Input stored in inputMessage state
   â””â”€â”€ User presses Enter or clicks Send button

3ï¸âƒ£ FRONTEND PROCESSING (ChatBotPage.tsx)
   â”œâ”€â”€ handleSendMessage() is triggered
   â”œâ”€â”€ Creates user message object:
   â”‚   {
   â”‚     id: '1234567890',
   â”‚     text: 'What departments are there?',
   â”‚     sender: 'user',
   â”‚     timestamp: new Date()
   â”‚   }
   â”œâ”€â”€ Adds to messages array (displays in UI)
   â”œâ”€â”€ Sets isLoading = true (shows loading spinner)
   â””â”€â”€ Calls getBotResponse('What departments are there?')

4ï¸âƒ£ GEMINI SERVICE PROCESSING (geminiService.ts)
   â”œâ”€â”€ generateResponse() method called
   â”œâ”€â”€ Checks if greeting â†’ NO (not "hi" or "hello")
   â”œâ”€â”€ Calls knowledgeBaseService.getContextForAI()
   â””â”€â”€ Waits for database data...

5ï¸âƒ£ KNOWLEDGE BASE SERVICE (knowledgeBaseService.ts)
   â”œâ”€â”€ getContextForAI('What departments are there?') called
   â”œâ”€â”€ Makes HTTP POST request to API:
   â”‚   URL: http://localhost:8080/api/knowledge-base/query
   â”‚   Body: { query: 'What departments are there?' }
   â””â”€â”€ Waits for API response...

6ï¸âƒ£ API SERVER (knowledge-base-api.js)
   â”œâ”€â”€ Receives POST request at /api/knowledge-base/query
   â”œâ”€â”€ Extracts query: "What departments are there?"
   â”œâ”€â”€ Calls Supabase database...
   â””â”€â”€ Waits for database results...

7ï¸âƒ£ SUPABASE DATABASE
   â”œâ”€â”€ Executes SQL query:
   â”‚   SELECT * FROM knowledge_base
   â”‚   WHERE (title ILIKE '%departments%' OR content ILIKE '%departments%')
   â”‚   AND is_active = true
   â”œâ”€â”€ Finds matching records:
   â”‚   - Civil Engineering Department
   â”‚   - Mechanical Engineering Department
   â”‚   - Electrical & Electronic Engineering
   â”‚   - Computer Engineering
   â”‚   - Chemical & Process Engineering
   â”‚   - Production Engineering
   â”‚   - Materials Engineering
   â”‚   - Engineering Mathematics
   â””â”€â”€ Returns 8 department records

8ï¸âƒ£ API SERVER (Returns Response)
   â”œâ”€â”€ Receives data from Supabase
   â”œâ”€â”€ Formats as JSON:
   â”‚   {
   â”‚     success: true,
   â”‚     data: [
   â”‚       { id: 1, title: 'Civil Engineering', content: '...' },
   â”‚       { id: 2, title: 'Mechanical Engineering', content: '...' },
   â”‚       ...
   â”‚     ]
   â”‚   }
   â””â”€â”€ Sends response to knowledgeBaseService

9ï¸âƒ£ KNOWLEDGE BASE SERVICE (Returns Context)
   â”œâ”€â”€ Receives API response
   â”œâ”€â”€ Formats data for AI:
   â”‚   "CATEGORY: Department
   â”‚    TITLE: Civil Engineering
   â”‚    CONTENT: The Department of Civil Engineering...
   â”‚    ---
   â”‚    CATEGORY: Department
   â”‚    TITLE: Mechanical Engineering
   â”‚    CONTENT: ..."
   â””â”€â”€ Returns formatted string to geminiService

ğŸ”Ÿ GEMINI SERVICE (Calls AI)
   â”œâ”€â”€ Receives formatted knowledge base content
   â”œâ”€â”€ Builds enhanced prompt:
   â”‚   "You are an AI assistant...
   â”‚    
   â”‚    KNOWLEDGE BASE CONTENT:
   â”‚    [All 8 departments data here]
   â”‚    
   â”‚    RULES:
   â”‚    1. Use ONLY this data
   â”‚    2. Give detailed answers
   â”‚    3. Use bullet points
   â”‚    ...
   â”‚    
   â”‚    User: What departments are there?"
   â”œâ”€â”€ Sends to Google Gemini AI API
   â””â”€â”€ Waits for AI response...

1ï¸âƒ£1ï¸âƒ£ GOOGLE GEMINI AI
   â”œâ”€â”€ Receives prompt with instructions + data + question
   â”œâ”€â”€ Processes using gemini-2.0-flash-exp model
   â”œâ”€â”€ Generates detailed response:
   â”‚   "The Faculty of Engineering has 8 departments:
   â”‚    
   â”‚    â€¢ Civil Engineering - [details from database]
   â”‚    â€¢ Mechanical Engineering - [details from database]
   â”‚    â€¢ Electrical & Electronic Engineering - [details]
   â”‚    â€¢ Computer Engineering - [details]
   â”‚    â€¢ Chemical & Process Engineering - [details]
   â”‚    â€¢ Production Engineering - [details]
   â”‚    â€¢ Materials Engineering - [details]
   â”‚    â€¢ Engineering Mathematics - [details]
   â”‚    
   â”‚    [Additional context from database]"
   â””â”€â”€ Returns response to geminiService

1ï¸âƒ£2ï¸âƒ£ GEMINI SERVICE (Returns to Frontend)
   â”œâ”€â”€ Receives AI response text
   â”œâ”€â”€ Returns to ChatBotPage.tsx
   â””â”€â”€ getBotResponse() receives the answer

1ï¸âƒ£3ï¸âƒ£ FRONTEND DISPLAYS RESPONSE
   â”œâ”€â”€ Creates bot message object:
   â”‚   {
   â”‚     id: '1234567891',
   â”‚     text: 'The Faculty of Engineering has 8 departments...',
   â”‚     sender: 'bot',
   â”‚     timestamp: new Date()
   â”‚   }
   â”œâ”€â”€ Adds to messages array
   â”œâ”€â”€ UI updates (shows bot message)
   â”œâ”€â”€ Sets isLoading = false (hides spinner)
   â””â”€â”€ Auto-scrolls to bottom

1ï¸âƒ£4ï¸âƒ£ USER SEES ANSWER
   â””â”€â”€ Detailed list of all 8 departments displayed in chat! âœ…


TIME BREAKDOWN:
- Step 1-3 (User input): ~0ms (instant)
- Step 4-9 (Database fetch): ~200-500ms
- Step 10-11 (AI processing): ~1-3 seconds
- Step 12-14 (Display): ~0ms (instant)
TOTAL: ~2-4 seconds for complete response


================================================================================
8. CONFIGURATION FILES
================================================================================

ğŸ“‹ PACKAGE.JSON (API Server)

FILE: utils/chatbot-server/package.json
```json
{
  "name": "knowledge-base-api",
  "version": "1.0.0",
  "dependencies": {
    "@supabase/supabase-js": "^2.47.10",  // Supabase client
    "express": "^4.21.2",                  // Web server
    "cors": "^2.8.5",                      // Cross-origin requests
    "dotenv": "^16.4.7"                    // Environment variables
  }
}
```

ğŸ“‹ ENVIRONMENT VARIABLES

FILE: utils/chatbot-server/.env
```
SUPABASE_URL=https://nzomtfszluifyvfmsoei.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
KB_API_PORT=8080
```

FRONTEND ENVIRONMENT (.env in project root):
```
VITE_GOOGLE_GEMINI_API_KEY=your_gemini_api_key_here
```

ğŸ“‹ TYPESCRIPT CONFIGURATION

The project uses TypeScript for type safety:
- Interfaces for Message structure
- Type checking for API responses
- Better IDE autocomplete
- Catch errors before runtime


================================================================================
9. CODE EXPLANATION - FILE BY FILE
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE: ChatBotPage.tsx                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PURPOSE: Main chatbot user interface component

KEY CODE SECTIONS:

1. INITIAL WELCOME MESSAGE (Lines 17-29)
```typescript
useEffect(() => {
  const welcomeMessage: Message = {
    id: 'welcome-' + Date.now(),
    text: 'Hello! ğŸ‘‹ Welcome to EngEx! I\'m your AI assistant...',
    sender: 'bot',
    timestamp: new Date()
  }
  setMessages([welcomeMessage])
}, [])
```
WHAT IT DOES:
- Runs once when component loads
- Creates welcome message from bot
- Sets initial messages array
- User sees greeting immediately


2. GET BOT RESPONSE FUNCTION (Lines 40-50)
```typescript
const getBotResponse = async (userMessage: string): Promise<string> => {
  try {
    return await geminiService.generateResponse(userMessage)
  } catch (error) {
    return 'Sorry, I encountered an error. Please try again.'
  }
}
```
WHAT IT DOES:
- Calls AI service with user's question
- Waits for response (async/await)
- Returns AI-generated answer
- Catches errors and shows friendly message


3. SEND MESSAGE HANDLER (Lines 52-88)
```typescript
const handleSendMessage = async () => {
  if (!inputMessage.trim() || isLoading) return
  
  // Add user message
  const userMsg: Message = {
    id: 'user-' + Date.now(),
    text: inputMessage,
    sender: 'user',
    timestamp: new Date()
  }
  setMessages(prev => [...prev, userMsg])
  setInputMessage('')
  setIsLoading(true)
  
  // Get bot response
  const botText = await getBotResponse(inputMessage)
  
  // Add bot message
  const botMsg: Message = {
    id: 'bot-' + Date.now(),
    text: botText,
    sender: 'bot',
    timestamp: new Date()
  }
  setMessages(prev => [...prev, botMsg])
  setIsLoading(false)
}
```
WHAT IT DOES:
- Validates input (not empty, not loading)
- Creates user message object
- Adds to messages array (shows in UI)
- Clears input field
- Shows loading spinner
- Calls AI service
- Creates bot message with response
- Adds bot message to array
- Hides loading spinner


4. AUTO-SCROLL (Lines 90-96)
```typescript
useEffect(() => {
  if (messagesEndRef.current) {
    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' })
  }
}, [messages])
```
WHAT IT DOES:
- Runs whenever messages array changes
- Finds bottom of chat container
- Smoothly scrolls to bottom
- User always sees latest message


5. CHAT WINDOW UI (Lines 120-200)
```typescript
{isOpen && (
  <div className="chatbot-container">
    {/* Header */}
    <div className="chatbot-header">
      <h3>EngEx Assistant</h3>
      <div className="status">
        <div className="status-indicator"></div>
        <span>AI Active</span>
      </div>
      <button onClick={() => setIsOpen(false)}>Ã—</button>
    </div>
    
    {/* Messages */}
    <div className="chatbot-messages">
      {messages.map(msg => (
        <div key={msg.id} className={`message ${msg.sender}`}>
          {msg.text}
        </div>
      ))}
    </div>
    
    {/* Input */}
    <div className="chatbot-input">
      <input 
        value={inputMessage}
        onChange={(e) => setInputMessage(e.target.value)}
        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
      />
      <button onClick={handleSendMessage}>
        <Send />
      </button>
    </div>
  </div>
)}
```
WHAT IT DOES:
- Only shows when isOpen = true
- Header with title, status, close button
- Messages container with all chat history
- Maps over messages array to display each message
- Input field with onChange handler
- Enter key triggers send
- Send button with icon


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE: geminiService.ts                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PURPOSE: Google Gemini AI integration and prompt management

KEY CODE SECTIONS:

1. GREETING DETECTION (Lines 27-36)
```typescript
private isGreeting(message: string): boolean {
  const greetings = ['hi', 'hello', 'hey', 'greetings', ...]
  const lowerMessage = message.toLowerCase().trim()
  return greetings.some(greeting => 
    lowerMessage === greeting || 
    lowerMessage.startsWith(greeting + ' ') ||
    lowerMessage.startsWith(greeting + ',')
  )
}
```
WHAT IT DOES:
- Converts message to lowercase
- Checks if it matches any greeting
- Detects "hi", "hello there", "hey,", etc.
- Returns true/false


2. INTRODUCTION RESPONSE (Lines 41-88)
```typescript
private getIntroductionResponse(): string {
  return `ğŸ‘‹ **Hello and Welcome to EngEx 2025!**
  
  I'm your AI-powered assistant...
  
  ğŸ¯ **How I Can Help You:**
  â€¢ Faculty Information
  â€¢ Exhibition Events
  â€¢ Departments
  ...`
}
```
WHAT IT DOES:
- Returns pre-formatted welcome message
- Explains chatbot capabilities
- Gives example questions
- No AI call needed (saves time/cost)


3. MAIN RESPONSE GENERATOR (Lines 90-180)
```typescript
async generateResponse(prompt: string): Promise<string> {
  // Check greeting first
  if (this.isGreeting(prompt)) {
    return this.getIntroductionResponse()
  }
  
  // Get database context
  const dbContext = await knowledgeBaseService.getContextForAI(prompt)
  
  // Build AI prompt with instructions
  const enhancedPrompt = `
    You are an AI assistant...
    
    KNOWLEDGE BASE CONTENT:
    ${dbContext}
    
    RULES:
    1. Use ONLY knowledge base data
    2. Give detailed answers
    ...
    
    User: ${prompt}
  `
  
  // Call Gemini AI
  const result = await this.model.generateContent(enhancedPrompt)
  return result.response.text()
}
```
WHAT IT DOES:
- Checks if greeting â†’ return intro
- Fetches relevant data from database
- Builds detailed prompt with:
  * AI behavior instructions
  * Knowledge base content
  * User's question
- Sends to Gemini API
- Returns AI-generated response


4. ERROR HANDLING (Lines 182-200)
```typescript
catch (error: unknown) {
  const errorMessage = error instanceof Error ? error.message : String(error)
  
  if (errorMessage.includes('quota') || errorMessage.includes('RATE_LIMIT')) {
    return 'âš ï¸ AI service experiencing high demand...'
  }
  
  if (errorMessage.includes('ERR_CONNECTION_REFUSED')) {
    return 'ğŸ”Œ Connection issue detected...'
  }
  
  return this.getFallbackResponse()
}
```
WHAT IT DOES:
- Catches any errors from API calls
- Checks error type
- Returns user-friendly message based on error
- Different messages for different errors


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE: knowledgeBaseService.ts                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PURPOSE: Communication layer between frontend and API server

KEY CODE SECTIONS:

1. API CONFIGURATION (Lines 1-5)
```typescript
const API_HOST = 'http://localhost:8080'

class KnowledgeBaseService {
  private baseUrl = API_HOST
}
```
WHAT IT DOES:
- Sets API server address
- Port 8080 matches server configuration


2. GET CONTEXT FOR AI (Lines 20-50)
```typescript
async getContextForAI(query: string): Promise<string> {
  try {
    const response = await fetch(`${this.baseUrl}/api/knowledge-base/query`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    })
    
    const result = await response.json()
    
    if (!result.success || !result.data.length) {
      return ''
    }
    
    // Format data for AI
    return result.data.map(item => `
      CATEGORY: ${item.category}
      TITLE: ${item.title}
      CONTENT: ${item.content}
      ${item.metadata ? `METADATA: ${JSON.stringify(item.metadata)}` : ''}
      ---
    `).join('\n')
  } catch (error) {
    console.error('Knowledge base fetch error:', error)
    return ''
  }
}
```
WHAT IT DOES:
- Makes HTTP POST request to API server
- Sends user's query
- Receives database results
- Formats data for AI consumption:
  * Each record separated by ---
  * Clear labels (CATEGORY, TITLE, etc.)
  * JSON metadata converted to string
- Returns formatted string
- Returns empty string if error/no results


3. QUERY METHOD (Lines 7-18)
```typescript
async query(searchQuery: string) {
  const response = await fetch(`${this.baseUrl}/api/knowledge-base/query`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query: searchQuery })
  })
  return response.json()
}
```
WHAT IT DOES:
- Simple query method
- Returns raw JSON response
- Used for direct API access if needed


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE: knowledge-base-api.js                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PURPOSE: Express.js API server for database operations

KEY CODE SECTIONS:

1. SERVER INITIALIZATION (Lines 1-20)
```javascript
const express = require('express')
const cors = require('cors')
const { supabase } = require('./db')

const app = express()
const PORT = process.env.KB_API_PORT || 8080

app.use(cors())
app.use(express.json())
app.use((req, res, next) => {
  console.log(`${req.method} ${req.path}`)
  next()
})
```
WHAT IT DOES:
- Creates Express app
- Gets port from environment (8080)
- Enables CORS (allows frontend to call API)
- Parses JSON request bodies
- Logs all requests to console


2. HEALTH CHECK ENDPOINT (Lines 22-27)
```javascript
app.get('/health', (req, res) => {
  res.json({ 
    success: true, 
    message: 'EngEx Knowledge Base API is running',
    timestamp: new Date()
  })
})
```
WHAT IT DOES:
- Simple endpoint to check if server is running
- Returns success message
- Used for testing/monitoring


3. QUERY ENDPOINT (Lines 29-55)
```javascript
app.post('/api/knowledge-base/query', async (req, res) => {
  const { query } = req.body
  
  if (!query) {
    return res.status(400).json({ 
      success: false, 
      error: 'Query parameter required' 
    })
  }
  
  try {
    const { data, error } = await supabase
      .from('knowledge_base')
      .select('*')
      .or(`title.ilike.%${query}%,content.ilike.%${query}%,tags.cs.{${query}}`)
      .eq('is_active', true)
      .order('created_at', { ascending: false })
    
    if (error) throw error
    
    res.json({ success: true, data })
  } catch (error) {
    res.status(500).json({ 
      success: false, 
      error: error.message 
    })
  }
})
```
WHAT IT DOES:
- Receives query from frontend
- Validates query exists
- Searches Supabase database:
  * Searches in title (case-insensitive)
  * Searches in content (case-insensitive)
  * Searches in tags array
  * Only active entries (is_active = true)
  * Orders by most recent first
- Returns matching records
- Handles errors gracefully


4. GET ALL ENDPOINT (Lines 70-85)
```javascript
app.get('/api/knowledge-base/all', async (req, res) => {
  try {
    const { data, error } = await supabase
      .from('knowledge_base')
      .select('*')
      .eq('is_active', true)
      .order('category', { ascending: true })
    
    if (error) throw error
    
    res.json({ success: true, data, count: data.length })
  } catch (error) {
    res.status(500).json({ success: false, error: error.message })
  }
})
```
WHAT IT DOES:
- Gets ALL active entries from database
- No filtering or searching
- Orders by category alphabetically
- Returns total count
- Used for getting complete dataset


5. SERVER START (Lines 110-115)
```javascript
app.listen(PORT, '127.0.0.1', () => {
  console.log(`âœ… Knowledge Base API running on port ${PORT}`)
  console.log(`ğŸ”— Health check: http://localhost:${PORT}/health`)
  console.log(`ğŸ“Š Database: Connected to Supabase`)
})
```
WHAT IT DOES:
- Starts server on port 8080
- Binds to 127.0.0.1 (localhost only)
- Logs startup message
- Shows health check URL


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE: db.js                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PURPOSE: Supabase database connection setup

COMPLETE CODE:
```javascript
const { createClient } = require('@supabase/supabase-js')
require('dotenv').config()

const supabaseUrl = process.env.SUPABASE_URL
const supabaseKey = process.env.SUPABASE_SERVICE_KEY

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ ERROR: Missing Supabase credentials in .env file')
  console.error('Required variables:')
  console.error('  - SUPABASE_URL')
  console.error('  - SUPABASE_SERVICE_KEY')
  process.exit(1)
}

const supabase = createClient(supabaseUrl, supabaseKey)

console.log('âœ… Supabase client initialized')
console.log(`ğŸ“ URL: ${supabaseUrl}`)

module.exports = { supabase }
```

WHAT IT DOES:
1. Imports Supabase library
2. Loads .env file variables
3. Gets URL and API key from environment
4. Validates credentials exist
5. If missing â†’ shows error and exits
6. Creates Supabase client connection
7. Logs successful connection
8. Exports client for use in other files

SUPABASE CLIENT METHODS:
- supabase.from('table_name') â†’ Select table
- .select('*') â†’ Get all columns
- .insert({...}) â†’ Insert new row
- .update({...}) â†’ Update existing row
- .delete() â†’ Delete row
- .eq('column', value) â†’ Filter by exact match
- .ilike('column', '%text%') â†’ Case-insensitive search
- .or('condition1,condition2') â†’ OR conditions


================================================================================
10. HOW TO RUN & TEST
================================================================================

ğŸš€ STEP-BY-STEP STARTUP GUIDE

PREREQUISITES:
âœ… Node.js installed (v18 or higher)
âœ… npm installed
âœ… Google Gemini API key
âœ… Supabase account with database setup

STEP 1: INSTALL DEPENDENCIES
```powershell
# Install API server dependencies
cd src/pages/kiosk/utils/chatbot-server
npm install

# Install frontend dependencies (from project root)
cd ../../../../..
npm install
```

STEP 2: CONFIGURE ENVIRONMENT VARIABLES

Create .env in chatbot-server folder:
```
SUPABASE_URL=https://nzomtfszluifyvfmsoei.supabase.co
SUPABASE_SERVICE_KEY=your_service_key_here
KB_API_PORT=8080
```

Create .env in project root:
```
VITE_GOOGLE_GEMINI_API_KEY=your_gemini_api_key_here
```

STEP 3: START API SERVER
```powershell
cd src/pages/kiosk/utils/chatbot-server
node knowledge-base-api.js
```

Expected output:
```
âœ… Supabase client initialized
ğŸ“ URL: https://nzomtfszluifyvfmsoei.supabase.co
âœ… Knowledge Base API running on port 8080
ğŸ”— Health check: http://localhost:8080/health
ğŸ“Š Database: Connected to Supabase
```

STEP 4: START FRONTEND
```powershell
# In new terminal, from project root
npm run dev
```

Expected output:
```
VITE v7.1.5  ready in 710 ms
âœ  Local:   http://localhost:5173/
âœ  Network: http://192.168.x.x:5173/
```

STEP 5: OPEN IN BROWSER
1. Navigate to http://localhost:5173
2. Go to Kiosk page
3. Click chatbot button (bottom-right)
4. Start chatting!

TESTING CHECKLIST:

âœ… Test greeting: Type "hi" â†’ Should show introduction
âœ… Test departments: "What departments are there?" â†’ Lists all 8
âœ… Test events: "What events are happening?" â†’ Shows exhibition events
âœ… Test contact: "Dean's office phone number?" â†’ Shows contact info
âœ… Test off-topic: "What's the weather?" â†’ Redirects to EngEx topics
âœ… Test detailed answer: "Tell me about Civil Engineering" â†’ Long detailed response

TROUBLESHOOTING:

âŒ "Connection refused" error:
   â†’ Check if API server is running on port 8080
   â†’ Run: curl http://localhost:8080/health

âŒ "API key not configured" error:
   â†’ Check .env file has VITE_GOOGLE_GEMINI_API_KEY
   â†’ Restart Vite server after adding env variable

âŒ "Empty responses" from chatbot:
   â†’ Check Supabase database has data (should have 43 entries)
   â†’ Test database: http://localhost:8080/api/knowledge-base/all

âŒ "EACCES permission denied":
   â†’ Port 8080 might be in use
   â†’ Change KB_API_PORT to different port (e.g., 8081)
   â†’ Update knowledgeBaseService.ts to match new port

MONITORING LOGS:

API Server logs show:
- POST /api/knowledge-base/query (every database query)
- Database query results
- Errors if any

Browser console shows:
- API requests
- Gemini AI calls
- Error messages
- Response times

PERFORMANCE METRICS:

Average response time: 2-4 seconds
- Database query: 200-500ms
- Gemini AI processing: 1-3 seconds
- UI rendering: <100ms

Database queries per conversation: 1 per user message
Gemini API calls per conversation: 1 per user message (except greetings)


================================================================================
KEY FEATURES SUMMARY
================================================================================

âœ… NO HARDCODED DATA - All information from Supabase database
âœ… DETAILED ANSWERS - Point-wise, comprehensive responses (max 4096 tokens)
âœ… GREETING DETECTION - Smart intro message for "hi", "hello", etc.
âœ… OFF-TOPIC HANDLING - Redirects to EngEx topics politely
âœ… REAL-TIME DATABASE - Live updates from Supabase
âœ… ERROR HANDLING - Graceful fallbacks for all error scenarios
âœ… RESPONSIVE UI - Works on all screen sizes
âœ… AUTO-SCROLL - Always shows latest messages
âœ… LOADING STATES - Visual feedback while processing
âœ… STATUS INDICATOR - Shows when AI is active

DATABASE STATISTICS:
- Total entries: 43 active records
- Categories: Departments, Events, Facilities, Contacts, Campus Map
- Tables: knowledge_base, conversations (chat history)
- Cloud-hosted: Supabase PostgreSQL


================================================================================
SECURITY NOTES
================================================================================

ğŸ”’ API KEYS:
- Never commit .env files to git
- Gemini API key stored in frontend env (VITE_ prefix)
- Supabase service key in backend env (server-side only)

ğŸ”’ SERVER BINDING:
- API bound to 127.0.0.1 (localhost only)
- Not accessible from external networks
- CORS enabled only for local development

ğŸ”’ DATABASE:
- Supabase Row Level Security (RLS) configured
- Service role key has full access
- Anon key would have restricted access


================================================================================
MAINTENANCE & UPDATES
================================================================================

TO ADD NEW DATA TO DATABASE:
1. Open Supabase dashboard
2. Go to SQL Editor
3. Run SQL insert/update statements
4. Changes reflect immediately in chatbot

TO UPDATE AI BEHAVIOR:
1. Edit geminiService.ts
2. Modify prompt instructions
3. Save file â†’ Vite auto-reloads
4. Test new behavior

TO CHANGE API PORT:
1. Update .env â†’ KB_API_PORT=new_port
2. Update knowledgeBaseService.ts â†’ API_HOST
3. Restart API server
4. Restart frontend

TO ADD NEW ENDPOINTS:
1. Add route in knowledge-base-api.js
2. Add method in knowledgeBaseService.ts
3. Call from frontend components


================================================================================
END OF DOCUMENTATION
================================================================================

For code review or questions:
- Check this file for detailed explanations
- Review inline comments in source files
- Test each component individually
- Monitor console logs for debugging

Happy coding! ğŸš€
